<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">
  <link rel="alternate" href="/blog/atom.xml" title="dev history" type="application/atom+xml">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Spring Batch">
<meta name="keywords" content="java,spring">
<meta property="og:type" content="article">
<meta property="og:title" content="rest-api-spring-batch">
<meta property="og:url" content="https:&#x2F;&#x2F;coderhglee.github.io&#x2F;2019&#x2F;11&#x2F;14&#x2F;rest-api-spring-batch&#x2F;index.html">
<meta property="og:site_name" content="dev history">
<meta property="og:description" content="Spring Batch">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;24283191&#x2F;69026694-482e4300-0a0f-11ea-8f3f-7b7a793d1623.png">
<meta property="og:image" content="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;24283191&#x2F;69026697-495f7000-0a0f-11ea-963e-a75b7a2ef814.png">
<meta property="og:image" content="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;24283191&#x2F;69026696-48c6d980-0a0f-11ea-814f-fef33b5711d7.png">
<meta property="og:updated_time" content="2019-12-27T09:22:26.392Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;24283191&#x2F;69026694-482e4300-0a0f-11ea-8f3f-7b7a793d1623.png">

<link rel="canonical" href="https://coderhglee.github.io/2019/11/14/rest-api-spring-batch/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>rest-api-spring-batch | dev history</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">dev history</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>홈</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>카테고리</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>아카이브</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>태그</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="ko">
    <link itemprop="mainEntityOfPage" href="https://coderhglee.github.io/blog/2019/11/14/rest-api-spring-batch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="coderhglee">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dev history">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          rest-api-spring-batch
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-11-14 15:56:57" itemprop="dateCreated datePublished" datetime="2019-11-14T15:56:57+09:00">2019-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Updated at: 2019-12-27 18:22:26" itemprop="dateModified" datetime="2019-12-27T18:22:26+09:00">2019-12-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/java/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>
            </span>

          
            <div class="post-description">Spring Batch</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Requirement"><a href="#Requirement" class="headerlink" title="Requirement"></a>Requirement</h2><ul>
<li>평일 8시부터 18시까지 1분마다 API를 요청해 새로운 Data를 DB에 저장하고 뉴스 기사를 생성하는 Batch프로그램을 개발한다.</li>
</ul>
<h2 id="Why-Spring-Batch"><a href="#Why-Spring-Batch" class="headerlink" title="Why Spring Batch?"></a>Why Spring Batch?</h2><p>기존 사내 Batch는 단순 Thread로 구성되어있어서 상당히 코드가 복잡한 부분이 있었다. 하지만 Spring Batch는 Spring의 DI, AOP, 추상화등 Spring Framework의 요소를 모두 사용할수있고, Framework의 러닝커브가 조금 있지만 잘 사용만하면 코드가 상당히 깔끔해지는 부분이 있어서 Batch Framework를 도입하였다.</p>
<h2 id="Batch-Meta-Data-Schema"><a href="#Batch-Meta-Data-Schema" class="headerlink" title="Batch Meta-Data Schema"></a>Batch Meta-Data Schema</h2><p>Spring Batch에선 메타 데이터 테이블들이 필요하다.</p>
<ul>
<li>이전에 실행한 Job이 어떤 것들이 있는지</li>
<li>최근 실패한 Batch Parameter가 어떤것들이 있고, 성공한 Job은 어떤것들이 있는지</li>
<li>다시 실행한다면 어디서 부터 시작하면 될지</li>
<li>어떤 Job에 어떤 Step들이 있었고, Step들 중 성공한 Step과 실패한 Step들은 어떤것들이 있는지</li>
</ul>
<p>아래는 메타 테이블의 구조이다.</p>
<p><img src="https://user-images.githubusercontent.com/24283191/69026694-482e4300-0a0f-11ea-8f3f-7b7a793d1623.png" alt="Meta-Data Schema"></p>
<p>하지만 나는 DB에서 최근 수집된 날짜를 조회한뒤 그 이후 날짜에 대한 데이터를 가져오기때문에 특정 날짜에 대한 Job을 실패한다면 다음 Job에서도 똑같은 날짜를 성공할때까지 계속 요청할것이기 때문에 이러한 상태정보를 저장할 필요성을 느끼지 못하였다. 하지만 추후 어떤 장애가 발생되었을때 알림이 오는 프로세스는 개발이 필요할것같다 Slack봇을 활용할 생각이다.</p>
<h2 id="In-Memory-Repository"><a href="#In-Memory-Repository" class="headerlink" title="In-Memory Repository"></a>In-Memory Repository</h2><p>도메인 개체를 데이터베이스에 유지하지 않으려는 2가지 시나리오.</p>
<ul>
<li><p>한 가지 이유는 속도. 각 커밋 지점에 도메인 개체를 저장하는 데 추가 시간이 걸리기 때문.</p>
</li>
<li><p>두번째 특정 작업에 대한 상태를 유지할 필요가 없음.</p>
</li>
</ul>
<p>이러한 이유로 Spring Batch에서 제공하는 Meta-Data를 사용하지않고 Batch 프로그램을 구동시키기 위한 <code>BatchConfigurer</code> 인터페이스를 상속받은 <code>InMemoryBatchConfigurer</code> Class를 구성했다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryBatchConfigurer</span> <span class="keyword">implements</span> <span class="title">BatchConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line">    <span class="keyword">private</span> JobRepository jobRepository;</span><br><span class="line">    <span class="keyword">private</span> JobLauncher jobLauncher;</span><br><span class="line">    <span class="keyword">private</span> JobExplorer jobExplorer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">getTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobRepository <span class="title">getJobRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobLauncher <span class="title">getJobLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobLauncher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobExplorer <span class="title">getJobExplorer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobExplorer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//의존성 주입이 이루어진후 초기화를 수행하는 메소드이다.</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//transactionManager define</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.transactionManager = <span class="keyword">new</span> ResourcelessTransactionManager();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//jobRepository define</span></span><br><span class="line">            <span class="comment">//MapJobRepositoryFactoryBean -&gt; using non-persistent in-memory DAO implementations </span></span><br><span class="line">            MapJobRepositoryFactoryBean jobRepositoryFactoryBean =</span><br><span class="line">                    <span class="keyword">new</span> MapJobRepositoryFactoryBean(<span class="keyword">this</span>.transactionManager);</span><br><span class="line">            jobRepositoryFactoryBean.afterPropertiesSet();</span><br><span class="line">            <span class="keyword">this</span>.jobRepository = jobRepositoryFactoryBean.getObject();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//jobExplorer define</span></span><br><span class="line">            MapJobExplorerFactoryBean jobExplorerFactoryBean =</span><br><span class="line">                    <span class="keyword">new</span> MapJobExplorerFactoryBean(jobRepositoryFactoryBean);</span><br><span class="line">            jobExplorerFactoryBean.afterPropertiesSet();</span><br><span class="line">            <span class="keyword">this</span>.jobExplorer = jobExplorerFactoryBean.getObject();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//jobLauncher define</span></span><br><span class="line">            SimpleJobLauncher jobLauncher = <span class="keyword">new</span> SimpleJobLauncher();</span><br><span class="line">            jobLauncher.setJobRepository(jobRepository);</span><br><span class="line">            jobLauncher.afterPropertiesSet();</span><br><span class="line">            <span class="keyword">this</span>.jobLauncher = jobLauncher;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BatchConfigurationException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="EnableScheduling"><a href="#EnableScheduling" class="headerlink" title="EnableScheduling"></a>EnableScheduling</h2><p>스케줄러중에 Quartz라는 프레임워크도있고 젠킨슨같은 CI툴을 사용할수도있지만 아직 사내에 도입하지 않았기때문에 @Scheduled 어노테이션을 활용했다.<br>cron 문법을 사용해서 0 0/1 8-18 * * MON-FRI 으로 정의하였고 월~금 08시 00분 부터 18시 59분 까지 1분마다 해당 메소드가 실행된다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppScheduler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Job job;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobLauncher jobLauncher;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//JPA Repository</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RobotNewsRepository newsRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//기사 생성 Service</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleService articleService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//스케쥴러 0 0/1 8-18 * * MON-FRI</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0 0/1 8-18 * * MON-FRI"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//실행 시간 밀리타임.</span></span><br><span class="line">        Long runTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"Job Started at : &#123;&#125;"</span>, runTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//DB에서 마지막 수집된 기사 생성시간 조회한다</span></span><br><span class="line">        String lastCreatedDate = newsRepository.getLastCreatedDate();</span><br><span class="line">        <span class="comment">//Null 이면 오늘 날짜에 00:00:00 으로 가져옴.</span></span><br><span class="line">        <span class="keyword">if</span> (lastCreatedDate == <span class="keyword">null</span>) &#123;</span><br><span class="line">            lastCreatedDate = LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd"</span>)) + <span class="string">" 00:00:00"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//JobParameters</span></span><br><span class="line">        JobParameters param =</span><br><span class="line">                <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">                        .addString(<span class="string">"lastCreatedDate"</span>, lastCreatedDate)</span><br><span class="line">                        .addLong(<span class="string">"runTime"</span>, runTime).toJobParameters();</span><br><span class="line">        <span class="comment">//Job 실행 Class</span></span><br><span class="line">        JobExecution execution = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">"Job Param : &#123;&#125;"</span>, param.toString());</span><br><span class="line">            execution = jobLauncher.run(job, param);</span><br><span class="line">            log.info(<span class="string">"Job finished apiJob with status : &#123;&#125;"</span>, execution.getStatus());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Job 실행 결과 COMPLETED이면 저장된 비동기 Static Queue Size 만큼 기사생성 Service 호출.</span></span><br><span class="line">        <span class="comment">//해당 내용은 아래에 설명.</span></span><br><span class="line">        <span class="keyword">if</span> (execution.getStatus().equals(BatchStatus.COMPLETED)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; staticDtoQueue.size(); i++) &#123;</span><br><span class="line">                articleService.articleTask();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h2><p><img src="https://user-images.githubusercontent.com/24283191/69026697-495f7000-0a0f-11ea-963e-a75b7a2ef814.png" alt="Job"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobBuilderFactory jobBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StepBuilderFactory stepBuilderFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> InterceptingJobExecution interceptingJobExecution;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//API호출을 위한 RestTemplate 사용</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">apiJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"apiJob"</span>)</span><br><span class="line">                .incrementer(<span class="keyword">new</span> RunIdIncrementer())</span><br><span class="line">                .flow(apiJobStep())</span><br><span class="line">                .end()</span><br><span class="line">                .listener(interceptingJobExecution)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Step <span class="title">apiJobStep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.stepBuilderFactory.get(<span class="string">"apiJobStep"</span>)</span><br><span class="line">                .&lt;Object, Object&gt;chunk(<span class="number">10</span>) <span class="comment">// 최소 Chunk의 사이즈는 10임. 그이하는 Exception</span></span><br><span class="line">                .reader(reader(restTemplate, <span class="keyword">null</span>))</span><br><span class="line">                .processor(processor())</span><br><span class="line">                .writer(writer())</span><br><span class="line">                .allowStartIfComplete(<span class="keyword">true</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@JobScope</span>는 Job 실행시점에 Bean이 생성됨.</span></span><br><span class="line"><span class="comment">     * org.springframework.batch.item.ItemReader는 인터페이스이다. 구현 클래스는 어노테이션 기반 listner 구성에 대해 실행되지 않음.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Bean</span> 메소드에서 <span class="doctag">@StepScope</span>를 사용하는 경우 listner 어노테이션을 사용할 수 있도록 구현 클래스를 리턴해야함</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@StepScope</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonReader <span class="title">reader</span><span class="params">(RestTemplate restTemplate, @Value(<span class="string">"#&#123;jobParameters[lastCreatedDate]&#125;"</span>)</span> String lastCreatedDate) </span>&#123;</span><br><span class="line">        String requestUrl = String.format(url, lastCreatedDate, limit, desc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JsonReader(restTemplate, requestUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonProcessor <span class="title">processor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JsonProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonWrite <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JsonWrite();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chunk-Processing"><a href="#Chunk-Processing" class="headerlink" title="Chunk Processing"></a>Chunk Processing</h2><p>스프링 배치는 ‘Chunk 지향’처리 스타일을 사용한다.<br>Chunk 지향 처리는 한 번에 하나씩 데이터를 읽고 트랜잭션 경계 내에서 작성된 Chunk를 작성하는 것을 말한다.<br>하나의 Item이 ItemReader에서 읽혀지고 ItemProcessor로 전달된다.<br>읽은 Item 수가 커밋 간격과 같으면 ItemWriter가 전체 Chunk를 작성한 다음 트랜잭션이 커밋된다.</p>
<p><img src="https://user-images.githubusercontent.com/24283191/69026696-48c6d980-0a0f-11ea-814f-fef33b5711d7.png" alt="chunk-oriented Processing"></p>
<h2 id="Reader"><a href="#Reader" class="headerlink" title="Reader"></a>Reader</h2><p>API를 호출하고 Json을 jackson 라이브러리를 통하여 Java <code>List&lt;Object&gt;</code>로 컨버팅 후 Object로 반환</p>
<h3 id="CustomObjectMapper"><a href="#CustomObjectMapper" class="headerlink" title="CustomObjectMapper"></a>CustomObjectMapper</h3><p>LocalDateTime을 한꺼번에 포맷팅하기 위해 jackson object mapper를 재정의 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomLocalDateTimeDeserializer</span> <span class="keyword">extends</span> <span class="title">JsonDeserializer</span>&lt;<span class="title">LocalDateTime</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DATE_FORMAT = <span class="string">"yyyy-MM-dd'T'HH:mm:ss.SSSXXX"</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">deserialize</span><span class="params">(JsonParser jsonParser, DeserializationContext ctxt)</span> <span class="keyword">throws</span> IOException, JsonProcessingException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String valueAsString = jsonParser.getValueAsString();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(valueAsString)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DateTimeFormatter formatter = DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)</span><br><span class="line">                    .withZone(ZoneId.of(<span class="string">"UTC"</span>));</span><br><span class="line">            LocalDateTime ldt = LocalDateTime.parse(valueAsString,formatter);</span><br><span class="line">            <span class="keyword">return</span> ldt;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomObjectMapper</span> <span class="keyword">extends</span> <span class="title">ObjectMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleModule simpleModule = <span class="keyword">new</span> SimpleModule();</span><br><span class="line">        simpleModule.addDeserializer(LocalDateTime<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">CustomLocalDateTimeDeserializer</span>())</span>;</span><br><span class="line"></span><br><span class="line">        registerModule(simpleModule);</span><br><span class="line">        <span class="comment">// 없는 필드로 인한 오류 무시</span></span><br><span class="line">        configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JsonReader"><a href="#JsonReader" class="headerlink" title="JsonReader"></a>JsonReader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonReader</span> <span class="keyword">implements</span> <span class="title">ItemReader</span>&lt;<span class="title">NewsDto</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//요청 url</span></span><br><span class="line">    <span class="keyword">private</span> String requestUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//list index</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; list;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JsonReader 는 StepScope로 설정되어 프로그램 실행때마다 Baen을 재생성 하기때문에 Autowired 어노테이션이 제기능을 못함.</span></span><br><span class="line"><span class="comment">     * 미리 설정한 restTemplate Bean을 사용하기위해 BatchConfig에서 생성자로 전달받음.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> restTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestUrl</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonReader</span><span class="params">(RestTemplate restTemplate,String requestUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.restTemplate = restTemplate;</span><br><span class="line">        <span class="keyword">this</span>.requestUrl = requestUrl;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object content = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//리스트 사이즈만큼 content를 하나씩 읽는다.</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt; list.size()) &#123;</span><br><span class="line">            content = list.get(index);</span><br><span class="line">            index++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//초기 0</span></span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        list = setList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Object&gt; <span class="title">setList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//LocalDateTime 파싱을 위한 CustomObjectMapper 정의.</span></span><br><span class="line">        <span class="comment">//해당 내용은 아래에 설명.</span></span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> CustomObjectMapper();</span><br><span class="line">        List&lt;Object&gt; objectList = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ResponseEntity&lt;String&gt; response = restTemplate.getForEntity(requestUrl, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">"call URL &#123;&#125;"</span>, requestUrl);</span><br><span class="line"></span><br><span class="line">            JsonNode root = objectMapper.readTree(response.getBody());</span><br><span class="line"></span><br><span class="line">            JsonNode news = root.path(<span class="string">"news"</span>);</span><br><span class="line">            ObjectReader objectReader = objectMapper.readerFor(<span class="keyword">new</span> TypeReference&lt;List&lt;Object&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            objectList = objectReader.readValue(news);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            log.info(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> objectList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h2><p>Database로 insert, update 하기 위해 내용 이미지 분리 및 html 파싱작업  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonProcessor</span> <span class="keyword">implements</span> <span class="title">ItemProcessor</span>&lt;<span class="title">Object</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">process</span><span class="params">(Object item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//item을 받아 자신에게 맞는 Object로 정의한후 리턴.</span></span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Writer"><a href="#Writer" class="headerlink" title="Writer"></a>Writer</h2><p>Database로 저장하는 작업.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonWrite</span> <span class="keyword">implements</span> <span class="title">ItemWriter</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(<span class="string">"oracleTransactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(List&lt;? extends Object&gt; items)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Processor에서 정의한 Object를 List&lt;Object&gt;로 받는다 size는 초기에 셋팅한 Chuck단위인 10개씩</span></span><br><span class="line">        <span class="keyword">for</span> (Object item : items) &#123;</span><br><span class="line">          <span class="comment">//DB insert or update</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">//기사 아이디 Static Queue 추가</span></span><br><span class="line">          staticDtoQueue.add(<span class="keyword">new</span> StaticDto(newsContent.getContentId()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="비동기-서비스"><a href="#비동기-서비스" class="headerlink" title="비동기 서비스"></a>비동기 서비스</h2><ul>
<li>내부 시스템에서 기사를 생성하는데 10~20초 정도 소요됨.</li>
<li>만약 기사가 5개 생성된다면 최대 100초가 걸림.</li>
<li>즉 1분안에 모든 로직이 완료된다는 보장이 없음.</li>
</ul>
<h3 id="TaskExecutor-Bean"><a href="#TaskExecutor-Bean" class="headerlink" title="TaskExecutor Bean"></a>TaskExecutor Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//최초 생성되는 스레드 사이즈</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_TASK_POOL_SIZE = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//해당 풀에 최대로 유지할 수 있는 스레드 사이즈</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_TASK_POOL_SIZE = <span class="number">30</span>;</span><br><span class="line"><span class="comment">//CorePoll보다 스레드가 많아졌을 경우, 남는 스레드가 없을 경우 큐에 담을수있는 사이즈</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> QUEUE_CAPACITY_SIZE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"taskExecutor"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> TaskExecutor <span class="title">executor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">    executor.setCorePoolSize(CORE_TASK_POOL_SIZE);</span><br><span class="line">    executor.setMaxPoolSize(MAX_TASK_POOL_SIZE);</span><br><span class="line">    executor.setQueueCapacity(QUEUE_CAPACITY_SIZE);</span><br><span class="line">    executor.setThreadNamePrefix(<span class="string">"task-pool-"</span>);</span><br><span class="line"></span><br><span class="line">    executor.initialize();</span><br><span class="line">    <span class="keyword">return</span> executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="정적-큐-선언"><a href="#정적-큐-선언" class="headerlink" title="정적 큐 선언"></a>정적 큐 선언</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BasicConfig class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Queue&lt;StaticDto&gt; staticDtoQueue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li>프로세스를 재시작할때 기사 생성 누락을 방지하기위해 누락된 기사 조회 후 정적 큐에 Add</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 모든 Bean 특성이 설정되면 구성 및 최종 초기화</span></span><br><span class="line"><span class="comment">//InitializingMetaDataBean class</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitializingMetaDataBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RobotNewsRepository newsRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//오늘 날짜에 생성되지 않은 기사를 큐에 초기 셋팅.</span></span><br><span class="line">        String today = LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">"yyyyMMdd"</span>));</span><br><span class="line">        List&lt;String&gt; contentList = newsRepository.getNotYetCreatedContent(today);</span><br><span class="line">        log.info(<span class="string">"InitializingMetaDataBean Queue Size &#123;&#125;"</span>,contentList.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String contentId : contentList) &#123;</span><br><span class="line">            staticDtoQueue.add(<span class="keyword">new</span> StaticDto(contentId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="비동기-메소드"><a href="#비동기-메소드" class="headerlink" title="비동기 메소드"></a>비동기 메소드</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//기사 생성 DTO</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String contentId;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticDto</span><span class="params">(String contentId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.contentId = contentId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//기사 생성 메소드</span></span><br><span class="line"><span class="meta">@Async</span>(<span class="string">"taskExecutor"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> RepeatStatus <span class="title">articleTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (staticDtoQueue.size() &lt;= <span class="number">0</span>) <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">    StaticDto staticDto = staticDtoQueue.poll();</span><br><span class="line"></span><br><span class="line">    String contentId = staticDto.getContentId();</span><br><span class="line">    String url = String.format(cmsUrl+<span class="string">"?fname=%s&amp;siteid=%s"</span>, contentId, siteId);</span><br><span class="line">    log.info(<span class="string">"기사 생성 시작 siteId &#123;&#125; contentId &#123;&#125;"</span>, siteId, contentId);</span><br><span class="line">    log.info(<span class="string">"Request URL &#123;&#125;"</span>, url);</span><br><span class="line"></span><br><span class="line">    ResponseEntity&lt;String&gt; response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = restTemplate.getForEntity(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ResourceAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"Response statusCode &#123;&#125;"</span>, response.getStatusCode());</span><br><span class="line"></span><br><span class="line">    String id = newsRepository.getExistId(contentId);</span><br><span class="line">    log.info(<span class="string">"ID IS &#123;&#125;"</span>, id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id != <span class="keyword">null</span>) &#123;</span><br><span class="line">        staticDto.setId(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (response.getStatusCode().equals(HttpStatus.OK) &amp;&amp; staticDto.getId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.info(<span class="string">"기사 생성 성공 siteId &#123;&#125; contentId &#123;&#125;"</span>, siteId, contentId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//만료시간 10분 추가.</span></span><br><span class="line">        LocalDateTime failNowTime = LocalDateTime.now();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (staticDto.getExpireTime() != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (staticDto.getExpireTime().isAfter(failNowTime)) &#123;</span><br><span class="line">                log.error(<span class="string">"기사 생성 시간 10분 초과 contentId &#123;&#125; expireTime &#123;&#125;"</span>, contentId, staticDto.getExpireTime());</span><br><span class="line">                <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            staticDto.setExpireTime(failNowTime.plusMinutes(<span class="number">10</span>));</span><br><span class="line">            log.error(<span class="string">"기사 생성 실패 siteId &#123;&#125; contentId &#123;&#125; expireTime &#123;&#125; "</span>, siteId, contentId, staticDto.getExpireTime());</span><br><span class="line">        &#125;</span><br><span class="line">        staticDtoQueue.add(staticDto);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RepeatStatus.FINISHED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/java/" rel="tag"># java</a>
              <a href="/blog/tags/spring/" rel="tag"># spring</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/blog/2019/11/18/git-basic-command/" rel="prev" title="git-basic-command">
                  git-basic-command <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          목차
        </li>
        <li class="sidebar-nav-overview">
          흝어보기
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Requirement"><span class="nav-number">1.</span> <span class="nav-text">Requirement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-Spring-Batch"><span class="nav-number">2.</span> <span class="nav-text">Why Spring Batch?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Batch-Meta-Data-Schema"><span class="nav-number">3.</span> <span class="nav-text">Batch Meta-Data Schema</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#In-Memory-Repository"><span class="nav-number">4.</span> <span class="nav-text">In-Memory Repository</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EnableScheduling"><span class="nav-number">5.</span> <span class="nav-text">EnableScheduling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Job"><span class="nav-number">6.</span> <span class="nav-text">Job</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chunk-Processing"><span class="nav-number">7.</span> <span class="nav-text">Chunk Processing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reader"><span class="nav-number">8.</span> <span class="nav-text">Reader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CustomObjectMapper"><span class="nav-number">8.1.</span> <span class="nav-text">CustomObjectMapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JsonReader"><span class="nav-number">8.2.</span> <span class="nav-text">JsonReader</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Processor"><span class="nav-number">9.</span> <span class="nav-text">Processor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Writer"><span class="nav-number">10.</span> <span class="nav-text">Writer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#비동기-서비스"><span class="nav-number">11.</span> <span class="nav-text">비동기 서비스</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TaskExecutor-Bean"><span class="nav-number">11.1.</span> <span class="nav-text">TaskExecutor Bean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#정적-큐-선언"><span class="nav-number">11.2.</span> <span class="nav-text">정적 큐 선언</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#비동기-메소드"><span class="nav-number">11.3.</span> <span class="nav-text">비동기 메소드</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">coderhglee</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">포스트</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">카테고리</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">태그</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/blog/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">coderhglee</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script>
<script src="/blog/js/schemes/pisces.js"></script>
<script src="/blog/js/next-boot.js"></script>



  
















  

  

</body>
</html>
